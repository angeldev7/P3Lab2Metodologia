name: CI/CD - Sistema de Gesti√≥n de Citas M√©dicas

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  test-and-coverage:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo fuente
      uses: actions/checkout@v4
      
    - name: Configurar Java 17
      uses: actions/setup-java@v4
      with:
        distribution: "temurin"
        java-version: "17"
        cache: "maven"
        
    - name: Mostrar informaci√≥n del proyecto
      run: |
        echo "üè• Sistema de Gesti√≥n de Citas M√©dicas - Lab 2"
        echo "üìã Ejecutando suite de pruebas para 3 historias cr√≠ticas:"
        echo "   - HU-001: Agendar Cita"
        echo "   - HU-002: Consultar Disponibilidad" 
        echo "   - HU-006: Gestionar Usuarios"
        
    - name: Validar estructura del proyecto
      run: |
        echo "üìÅ Verificando estructura del proyecto..."
        ls -la src/main/java/com/metodologia/
        ls -la src/test/java/com/metodologia/
        
    - name: Instalar dependencias
      run: mvn -B clean compile
      
    - name: Ejecutar suite de pruebas
      run: |
        echo "üß™ Ejecutando pruebas automatizadas..."
        mvn -B test
        
    - name: Generar reporte de cobertura JaCoCo
      run: |
        echo "üìä Generando reporte de cobertura..."
        mvn -B jacoco:report
        
    - name: Verificar cobertura m√≠nima (70%)
      run: |
        echo "üéØ Verificando cobertura m√≠nima del 70%..."
        mvn -B jacoco:check
        
    - name: Mostrar resumen de cobertura
      run: |
        echo "üìà Resumen de cobertura de c√≥digo:"
        if [ -f target/site/jacoco/index.html ]; then
          echo "‚úÖ Reporte de cobertura generado exitosamente"
          echo "üìÑ Ubicaci√≥n: target/site/jacoco/index.html"
        else
          echo "‚ùå Error: No se pudo generar el reporte de cobertura"
        fi
        
    - name: Subir reporte de cobertura
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: jacoco-coverage-report
        path: target/site/jacoco/
        retention-days: 30
        
    - name: Subir reportes de pruebas
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: target/surefire-reports/
        retention-days: 30
        
    - name: Resumen de resultados
      if: always()
      run: |
        echo "üèÅ Resumen de ejecuci√≥n del pipeline:"
        echo "üìä Historias probadas: 3 historias cr√≠ticas del Lab 1"
        echo "üß™ Pruebas ejecutadas: $(find target/surefire-reports -name "*.xml" | wc -l) archivos de reporte"
        echo "üìà Reporte de cobertura: target/site/jacoco/index.html"
        echo ""
        echo "‚ú® ¬°Pipeline CI/CD completado para el Sistema de Gesti√≥n de Citas M√©dicas!"
        
  quality-check:
    runs-on: ubuntu-latest
    needs: test-and-coverage
    
    steps:
    - name: Checkout c√≥digo fuente
      uses: actions/checkout@v4
      
    - name: Configurar Java 17
      uses: actions/setup-java@v4
      with:
        distribution: "temurin"
        java-version: "17"
        cache: "maven"
        
    - name: Validaci√≥n de calidad de c√≥digo
      run: |
        echo "üîç Ejecutando validaciones de calidad adicionales..."
        mvn -B compile
        
    - name: Verificar que no hay warnings de compilaci√≥n
      run: |
        echo "‚ö†Ô∏è  Verificando warnings de compilaci√≥n..."
        mvn -B compile 2>&1 | tee compile.log
        if grep -q "WARNING" compile.log; then
          echo "‚ùå Se encontraron warnings de compilaci√≥n"
          grep "WARNING" compile.log
          exit 1
        else
          echo "‚úÖ No se encontraron warnings de compilaci√≥n"
        fi
        
    - name: Resumen de validaci√≥n de calidad
      run: |
        echo "‚úÖ Validaciones de calidad completadas:"
        echo "   - Compilaci√≥n sin warnings"
        echo "   - C√≥digo fuente validado"
        echo "   - Estructura del proyecto verificada"